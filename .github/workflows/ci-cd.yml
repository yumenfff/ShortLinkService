name: Java CI/CD

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    build:
        name: Build on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest, windows-latest, macos-15-intel, macos-latest ]
            fail-fast: false

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Set up JDK 17
                uses: actions/setup-java@v4
                with:
                    distribution: temurin
                    java-version: 17
                    cache: maven

            -   name: Build with Maven
                run: mvn -B clean compile

    test:
        name: Test on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        needs: build
        strategy:
            matrix:
                os: [ ubuntu-latest, windows-latest, macos-15-intel, macos-latest ]
            fail-fast: false

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Set up JDK 17
                uses: actions/setup-java@v4
                with:
                    distribution: temurin
                    java-version: 17
                    cache: maven

            -   name: Run unit tests
                run: mvn -B test

    deploy:
        name: Deploy to Yandex Cloud VM
        runs-on: ubuntu-latest
        needs: test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up JDK 17
                uses: actions/setup-java@v4
                with:
                    distribution: temurin
                    java-version: 17
                    cache: maven

            -   name: Build JAR
                run: mvn -B clean package

            -   name: Copy JAR to VM
                uses: appleboy/scp-action@v1
                with:
                    host: ${{ secrets.DEPLOY_HOST }}
                    username: ${{ secrets.DEPLOY_USER }}
                    key: ${{ secrets.DEPLOY_SSH_KEY }}
                    port: 22
                    source: "target/shortlink.jar"
                    target: "~/shortlink/"

            -   name: Confirm file delivery
                uses: appleboy/ssh-action@v1
                with:
                    host: ${{ secrets.DEPLOY_HOST }}
                    username: ${{ secrets.DEPLOY_USER }}
                    key: ${{ secrets.DEPLOY_SSH_KEY }}
                    port: 22
                    script: |
                        if [ -f ~/shortlink/target/shortlink.jar ]; then
                          echo "JAR delivered to Yandex Cloud VM"
                        else
                          echo "JAR missing!" && exit 1
                        fi
